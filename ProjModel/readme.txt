$Id: readme.txt,v 1.3 2008/07/02 16:21:33 ted Exp ted $
============================================================
Modeling extracellular stimulation and recording with NEURON
============================================================

These files demonstrate an approach to representing extracellular stimulation 
and recording with NEURON that is based on the following assumptions:
1.  The cell is embedded in a conductive medium that is linear and purely 
resistive (no capacitive or inductive properties).  This allows the coupling 
between cell and stimulating/recording electrodes to be represented by transfer
resistances.
2.  Currents generated by the cell's own electrical activity have no effect on 
the stimulating field.
3.  The distance between any segment (not section) and the stimulating/recording
electrodes is large compared to the length of the segment.  As a corollary, the 
distance between any segment and the stimulating/recording electrodes is large
compared to the deviation of the segment from a straight line.  

Overview and usage
------------------

The built-in extracellular mechanism provides a convenient way to monitor net
transmembrane current density i_membrane throughout the model cell.

The custom mechanism xtra is used to report the contribution of local 
i_membrane to the total signal that would be picked up by an extracellular 
recording electrode.  This mechanism also has range variables called x, y, and
z that are used for local storage of the coordinates of segment centers
interpolated from the pt3d data.  These coordinates are used by hoc code that
computes the transfer resistances that couple the membrane to the extracellular 
recording and stimulating electrode.

Interpolation of segment center coordinates from pt3d data is done by the code 
in interpxyz.hoc

This package includes some frills:  dummy sections are used to produce xyz scale
bars, and a small dummy section is used to host a dummy IClamp, which in turn is
used to mark the location of the recording electrode (see proc drawelec() in 
calcrxc.hoc).  Also several of the space plots are purely for diagnostic/
development purposes.

To exercise this model, first compile xtra.mod, then use NEURON to run 
initxrec.hoc or initxstim.hoc.  Read the "Notes" box that appears, then Hide 
it or drag it to one side, and click on the Init & Run button.  To see a smooth
evolution of the time course of the space plots (plots of membrane potential 
vs. distance from the soma), bring up a Movie run tool (NEURON Main Menu / 
Tools / Movie Run) and click on its Init & Run button.

initxrec.hoc is an example of extracellular recording from a cell that is
stimulated by intracellular current injection.

initxstim.hoc is an example of extracellular recording from a cell that is
stimulated by an extracellular electrode.

The space plot of v shows a path that starts at the distal tip of an apical
dendrite near the top of the cell's shape plot, and passes through the soma and
then along the axon.  Membrane potential along the apical dendrite is plotted 
along the negative x axis, and the positive x axis shows v along the axon.

Explanation of implementation
-----------------------------

The chief tasks accomplished by this program are:

1.  Specifies cell topology, geometry, spatial discretization, and biophysical
properties.  A model cell managed by a CellBuilder is used to illustrate the
process of stimulation and recording.  The cell has passive basliar dendrites,
active soma and axon, and dendrites that are also active but with reducedchannel
densities.

2.  Determines the xyz coordinates of the centers of all segments.  This is 
done by proc grindaway() in interpxyz.hoc.  The xyz values are saved in range 
variables x, y, and z, which belong to the xtra mechanism (see xtra.mod), a 
density mechanism that inserted into all sections that are to be subjected to 
extracellular stimulation and/or recording.

3.  Based on these locations and the geometry of the stimulating electrodes, 
calculates the transfer resistances that are used to calculate
--the extracellular potential at each segment center that is produced by a unit 
of stimulating current
--the contribution of each segment's membrane current to the extracellular 
potential observed by the recording electrode.

The transfer resistances are calculated in calcrxc.hoc.  They are saved in a 
range variable called rx that belongs to the xtra mechanism.

4.  Specifies the time course of the stimulating current, which is saved in a 
pair of Vectors stim_amp and stim_time.  This is done in stim.hoc, which also 
sets up playback of stim_amp during a simulation by asserting 
stim_amp.play(&is_xtra, stim_time)
Since is_xtra is GLOBAL, this only has to be done for one instance of xtra,
i.e. at just one internal node of only one of the sections that contain xtra.

5.  Sets up pointers that link the xtra mechanism's POINTER variables ex and 
im to the extracellular mechanism's range variables e_extracellular and 
i_membrane.

xtra calculates ex from the stimulus:
ex = is*rx*(1e6)
where is is the amplitude of the stimulus current (see item 4 above), rx is the 
transfer resistance between the segment and the stimulating electrodes, and 
(1e6) is a scale factor that reconciles the units of the terms on the left and 
right hand sides of this assignment.  This calculation is done 
BEFORE BREAKPOINT so that the value of ex is ready to be used to advance to 
the next time step.

xtra uses im to calculate er, the contribution of each segment's membrane 
current to the potential observed by an extracellular recording electrode:
er = (10)*rx*im*area
where rx is the transfer resistance for the segment, area is the segment's 
surface area, and (10) is a scale factor that reconciles the units of the 
terms on the left and right hand sides of this assignment.  This calculation 
is done AFTER SOLVE so that er reflectes the effect of membrane current on 
extracellular potential _after_ the solution at the present time has been 
calculated.

6.  Sets the extracellular mechanism's longitudinal resistances to "infinite," 
its radial conductances to "infinite," and its radial capacitances to 
"infinitely small" so that each segment's membrane is effectively attached 
directly to the corresponding e_extracellular, and isolated from the 
e_extracellulars of its neighboring segments.

7.  During a simulation, the extracellularly recorded potential vrec is 
computed by summing up the contributions from all of the segments that contain 
the xtra mechanism.  This is done by func fieldrec() in field.hoc, which is 
called by custom init() and advance() procedures that are defined in the same 
file.


Here's a question for you:
Run initxstim.hoc and try eliciting a spike with various locations of the 
stimulating electrode.  Adjust the stimulus current so it is only ~1.5 x 
threshold.  Is there a location in the cell that seems to be a preferential 
site of spike initiation (examine the space plot)?  Why does this happen?
